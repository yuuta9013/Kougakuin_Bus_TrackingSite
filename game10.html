<script>
    // キャラクターの移動処理
    function moveCharacter(dx, dy) {
        const rect = character.getBoundingClientRect();
        const areaRect = gameArea.getBoundingClientRect();

        let newX = character.offsetLeft + dx;
        let newY = character.offsetTop + dy;

        // 移動範囲の制限
        newX = Math.max(0, Math.min(gameArea.clientWidth - rect.width, newX));
        newY = Math.max(0, Math.min(gameArea.clientHeight - rect.height, newY));

        character.style.left = newX + "px";
        character.style.top = newY + "px";

        checkCollision();
    }

    // ゲームパッドの入力処理
    function handleGamepadInput() {
        const gamepad = navigator.getGamepads()[gamepadIndex];
        if (!gamepad) return;

        const threshold = 0.2; // スティックの反応閾値
        const deadZone = 0.1;  // 中央付近のノイズを無視

        let axisX = gamepad.axes[0];
        let axisY = gamepad.axes[1];

        // デッドゾーンの設定
        axisX = Math.abs(axisX) > deadZone ? axisX : 0;
        axisY = Math.abs(axisY) > deadZone ? axisY : 0;

        // スティックが閾値を超える場合のみ移動
        if (Math.abs(axisX) > threshold) {
            moveCharacter(axisX * characterSpeed, 0);
        }
        if (Math.abs(axisY) > threshold) {
            moveCharacter(0, axisY * characterSpeed);
        }

        requestAnimationFrame(handleGamepadInput);
    }

    // 初期化処理はそのまま
    window.addEventListener("gamepadconnected", (event) => {
        gamepadIndex = event.gamepad.index;
        document.getElementById("resultDisplay").textContent = "ゲームパッド接続: 準備完了";
        requestAnimationFrame(handleGamepadInput);
    });

    window.addEventListener("gamepaddisconnected", () => {
        gamepadIndex = null;
        document.getElementById("resultDisplay").textContent = "ゲームパッドが切断されました";
    });

    placeTarget();
</script>
